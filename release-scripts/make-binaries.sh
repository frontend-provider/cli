#!/usr/bin/env bash
set -euo pipefail

# Do not run this file locally. To build release artifacts, see CONTRIBUTING.

make prepack

mv "$(npm pack --workspace '@snyk/fix')" binary-releases/snyk-fix.tgz
mv "$(npm pack --workspace '@snyk/protect')" binary-releases/snyk-protect.tgz
mv "$(npm pack)" binary-releases/snyk.tgz

npx pkg . --compress Brotli -t node16-alpine-x64 -o binary-releases/snyk-alpine
npx pkg . --compress Brotli -t node16-linux-x64  -o binary-releases/snyk-linux
npx pkg . --compress Brotli -t node16-macos-x64  -o binary-releases/snyk-macos
npx pkg . --compress Brotli -t node16-win-x64    -o binary-releases/snyk-win-unsigned.exe

# Why `--no-bytecode` for Linux/arm64:
#   arm64 bytecode generation requires various build tools on an x64 build
#   environment. So disabling until we can support it. It's an optimisation.
#   https://github.com/vercel/pkg#targets
npx pkg . --compress Brotli -t node16-linux-arm64 -o binary-releases/snyk-linux-arm64 --no-bytecode

./docker-desktop/build.sh darwin x64
./docker-desktop/build.sh darwin arm64
./release-scripts/docker-desktop-release.sh

# sign the windows binary
./release-scripts/sign-windows-binary.sh

# compute checksums
pushd binary-releases
shasum -a 256 snyk-alpine >snyk-alpine.sha256
shasum -a 256 snyk-linux >snyk-linux.sha256
shasum -a 256 snyk-linux-arm64 >snyk-linux-arm64.sha256
shasum -a 256 snyk-macos >snyk-macos.sha256
# note: checksum for snyk-win.exe is generated by `sign-windows-binary.sh`
# note: checksum for docker-mac-signed-bundle is generated by `docker-desktop-release.sh`
shasum -a 256 snyk-fix.tgz > snyk-fix.tgz.sha256
shasum -a 256 snyk-protect.tgz > snyk-protect.tgz.sha256
shasum -a 256 snyk.tgz > snyk.tgz.sha256

# GPG signed shasums file
cat ./*.sha256 >> sha256sums.txt

echo "Importing PGP key"
echo "$SNYK_CODE_SIGNING_PGP_PRIVATE" | base64 --decode | gpg --import --batch --passphrase="$SNYK_CODE_SIGNING_GPG_PASSPHRASE"

echo "Signing shasums file"
gpg --clear-sign --local-user=1F4B9569 --passphrase="$SNYK_CODE_SIGNING_GPG_PASSPHRASE" --pinentry-mode=loopback --armor --batch sha256sums.txt
cat sha256sums.txt.asc
popd

make binary-releases/release.json
make binary-releases/RELEASE_NOTES.md

ls -la
